# Update-Plan-Progress Fix: Critical Self-Review

**Date:** 2026-01-23
**Context:** Fix for sub-agents failing when calling update-plan-progress with phase names instead of numeric IDs
**Decision:** Accept phase names (strings) in addition to phase numbers (integers), add optional progress_percent
**Status:** Proposed (Pending Multi-LLM Review)
**Reviewed by:** Self-review, pending OpenAI GPT-5 and Google Gemini 3 Pro Preview

---

## Problem Statement

Sub-agents were calling:
```bash
update-plan-progress "bazinga_xxx" "LLKB_Adapter_Module" "completed" 100
```

But the implementation expected:
```python
phase_number = int(cmd_args[1])  # ValueError: invalid literal for int()
```

## Solution Implemented

1. Changed function signature to accept `Union[int, str]` for phase_id
2. Added lookup by phase name in addition to numeric ID
3. Added optional progress_percent parameter
4. Updated CLI parsing to try int conversion, fallback to string
5. Updated documentation in SKILL.md

## Critical Analysis

### Issues Found

#### A. Missing Status Validation

**Severity:** HIGH

The function doesn't validate that `status` is one of the valid values (`pending`, `in_progress`, `completed`, `blocked`). Invalid statuses are silently saved to the database.

**Evidence:** Other functions in the codebase validate status:
- `_validate_criterion_status()` at line 2293
- `update-session-status` CLI validates against `VALID_SESSION_STATUSES`

**Impact:** Database corruption, undefined behavior when reading invalid statuses.

**Fix Required:**
```python
VALID_PLAN_STATUSES = {'pending', 'in_progress', 'completed', 'blocked'}
if status not in VALID_PLAN_STATUSES:
    print(f"Error: Invalid status '{status}'. Must be one of: {', '.join(VALID_PLAN_STATUSES)}", file=sys.stderr)
    sys.exit(1)
```

---

#### B. Missing progress_percent Validation

**Severity:** MEDIUM

No range validation (should be 0-100), no type validation at function level.

**Current behavior:**
- `-50` would be accepted
- `150` would be accepted
- `50.5` from CLI would crash with `ValueError` in `int()`

**Fix Required:**
```python
if progress_percent is not None:
    if not (0 <= progress_percent <= 100):
        print(f"Error: progress_percent must be 0-100, got {progress_percent}", file=sys.stderr)
        sys.exit(1)
```

---

#### C. Confusing progress_percent Override on Completion

**Severity:** LOW

Current code:
```python
if progress_percent is not None:
    phase['progress_percent'] = progress_percent  # Set to 75
if status == 'completed':
    phase['completed_at'] = datetime.now().isoformat()
    phase['progress_percent'] = 100  # Overwritten to 100!
```

If user passes `status='completed'` with `progress_percent=75`, we set it to 75 then immediately overwrite to 100.

**Options:**
1. Keep current (completed = always 100%) - **RECOMMENDED** - semantically correct
2. Warn if progress_percent != 100 with completed status
3. Allow partial completion marking

**Decision:** Keep current behavior but document it explicitly.

---

#### D. Case-Sensitive Phase Name Matching

**Severity:** MEDIUM

Phase names are matched case-sensitively. If the plan has `"LLKB_Adapter_Module"` and an agent passes `"llkb_adapter_module"`, it won't match.

**Current behavior:** Exact match only → "Phase not found" error

**Options:**
1. Add case-insensitive option (`--ignore-case`)
2. Always match case-insensitively
3. Keep current (exact match) - **CURRENT**

**Recommendation:** Add case-insensitive matching as default with opt-out, since phase names are typically generated by PM and could have inconsistent casing across agents.

---

#### E. Ambiguous Matching Priority

**Severity:** LOW (edge case)

If a phase has numeric name like `{"phase": 1, "name": "2"}` and user calls with "2":
1. CLI converts "2" to int 2
2. Function looks for `phase_num == 2`
3. Matches wrong phase

**Mitigation:** This is an unlikely edge case. Numeric phase names are poor practice.

**Documentation needed:** "Numeric-looking strings passed via CLI are treated as phase numbers first."

---

#### F. current_phase Update Semantics

**Severity:** LOW (preserved existing behavior)

Original code: `current_phase = phase_number`
New code: `current_phase = matched_phase_num`

Both set `current_phase` to the phase being updated, regardless of logical progression.

**Question:** Should updating phase 3 set `current_phase = 3`? What if current_phase was 5?

**Decision:** Preserved backward compatibility. This semantic might be intentional (tracking which phase was last touched).

---

#### G. No Tests Exist

**Severity:** HIGH

```bash
$ grep -r "update_plan_progress" tests/
# No results
```

**Impact:** No regression protection, no documentation of expected behavior.

**Fix Required:** Add test coverage for:
- Numeric phase ID (backward compat)
- String phase name lookup
- progress_percent handling
- Invalid status rejection
- Phase not found error
- Case sensitivity behavior

---

#### H. Documentation Gaps

**Severity:** MEDIUM

1. `command_examples.md` - No examples for update-plan-progress
2. `schema.md` - No documentation of development_plans table or phases structure
3. No inline code comments explaining matching priority

---

### Pros of Implementation

1. **Backward Compatible** - Numeric phase IDs work identically
2. **Fixes Reported Issue** - String phase names now work
3. **Minimal Code Change** - ~50 lines changed
4. **Clear Error Messages** - "Phase not found" with the searched ID
5. **Optional progress_percent** - Doesn't break existing callers

### Cons of Implementation

1. **No Input Validation** - Status and progress_percent not validated
2. **No Tests** - No regression protection
3. **Case Sensitivity** - May cause issues with inconsistent casing
4. **Missing Documentation** - Examples and schema not updated

### Verdict

**Implementation is FUNCTIONAL but INCOMPLETE.**

The fix solves the immediate problem but introduces risk through missing validation and test coverage. The implementation should be enhanced before considering it production-ready.

---

## Recommended Enhancements

### Priority 1: Critical (Should Block Merge)

1. **Add status validation** - Prevent database corruption
2. **Add progress_percent validation** - Prevent invalid ranges
3. **Add basic test coverage** - At minimum 5 tests

### Priority 2: Important (Should Address Soon)

4. **Add case-insensitive matching** - Prevent agent casing mismatches
5. **Update command_examples.md** - Document new usage patterns
6. **Add fuzzy suggestion** - "Phase 'X' not found. Did you mean 'Y'?"

### Priority 3: Nice to Have

7. **Document in schema.md** - phases structure and valid statuses
8. **Add verbose logging** - For debugging phase matching
9. **Consider partial completion** - Allow completed at <100%?

---

## Backward Compatibility Assessment

| Scenario | Before | After | Compatible? |
|----------|--------|-------|-------------|
| `update-plan-progress session 1 completed` | Works | Works | YES |
| `update-plan-progress session "Phase1" completed` | Crashes | Works | YES (new feature) |
| `update-plan-progress session 1 completed 100` | Crashes | Works | YES (new feature) |
| `update-plan-progress session 1 invalid_status` | Saved | Saved | YES (bug preserved) |
| Error message format | Exception | Clean exit | NO (minor) |

**Breaking change:** Error output format changed from Python exception to formatted error message. Any code parsing stderr might break.

---

## Decision Tree Analysis

```
Input: session_id, phase_id_str, status, [progress_percent]

1. Parse phase_id_str
   ├─ Is numeric? → phase_id = int
   └─ Not numeric? → phase_id = str

2. Look up plan
   ├─ Plan exists? → Continue
   └─ No plan? → EXIT(1) "No plan found"

3. Search phases
   ├─ phase_id is int?
   │   └─ Match phase['phase'] == phase_id
   └─ phase_id is str?
       ├─ Match phase['name'] == phase_id  ← CASE SENSITIVE!
       └─ OR Match str(phase['phase']) == phase_id

4. Phase found?
   ├─ Yes → Update fields
   │   ├─ status → phase['status']  ← NO VALIDATION!
   │   ├─ progress_percent? → phase['progress_percent']  ← NO VALIDATION!
   │   └─ completed? → Set completed_at, progress=100
   └─ No → EXIT(1) "Phase not found"

5. Save to DB
   └─ Update phases JSON, current_phase, timestamp
```

**Loopholes identified:**
- No status validation (path 4)
- No progress_percent validation (path 4)
- Case-sensitive name matching (path 3)
- Numeric string ambiguity (path 1 → 3)

---

## Implementation Checklist (What Was Done vs What Should Be Done)

| Task | Done? | Notes |
|------|-------|-------|
| Accept phase names | YES | Core fix |
| Accept progress_percent | YES | Optional 4th arg |
| Validate status | NO | Missing critical validation |
| Validate progress_percent | NO | Missing range check |
| Handle phase not found | YES | Clean exit with message |
| Update SKILL.md | YES | Documented parameters |
| Update command_examples.md | NO | No examples added |
| Update schema.md | NO | No schema documentation |
| Add tests | NO | Zero test coverage |
| Case-insensitive matching | NO | Not implemented |

---

## References

- Original error: `int("LLKB_Adapter_Module")` → ValueError
- Fix commit: 6444931
- Affected files:
  - `.claude/skills/bazinga-db/scripts/bazinga_db.py`
  - `.claude/skills/bazinga-db-workflow/SKILL.md`

---

## Multi-LLM Review Integration

**Reviewed by:** OpenAI GPT-5 (2026-01-23)

### Critical Issues Identified by Review (MUST FIX)

| Issue | Severity | My Assessment | Action |
|-------|----------|---------------|--------|
| **Concurrency/Race Conditions** - Read-modify-write without locking can clobber concurrent updates | CRITICAL | VALID - I completely missed this. Multiple agents updating different phases will overwrite each other. | IMPLEMENT optimistic locking |
| **Status Validation Missing** | HIGH | VALID - Already identified in self-review | IMPLEMENT validation |
| **Progress Validation Missing** | MEDIUM | VALID - Already identified in self-review | IMPLEMENT 0-100 range check |
| **Timezone-naive timestamps** | MEDIUM | VALID - datetime.now() without UTC is bad practice | IMPLEMENT UTC timestamps |
| **Output Contract Violation** - SKILL.md says "Return ONLY raw JSON" but we emit human text | HIGH | VALID - This breaks API contract | IMPLEMENT JSON output |
| **Status Reversion Not Handled** - completed→in_progress leaves completed_at | MEDIUM | VALID - Creates misleading data | IMPLEMENT transition handling |

### Suggested Improvements (Should Address)

| Suggestion | Complexity | Benefit | Decision |
|------------|------------|---------|----------|
| Normalize phases into separate table | HIGH | Eliminates JSON clobbering, enables row-level locking | DEFER - Too invasive for this fix |
| Optimistic concurrency (WHERE updated_at = original) | MEDIUM | Prevents lost updates | IMPLEMENT |
| Idempotent updates (no-op if unchanged) | LOW | Reduces write contention | IMPLEMENT |
| Deterministic ambiguity handling | MEDIUM | Prevents wrong phase matches | IMPLEMENT - Fail on multiple matches |
| started_at timestamp on in_progress | LOW | Better tracking | IMPLEMENT |
| "Did you mean X?" fuzzy suggestion | MEDIUM | Better UX on mismatch | DEFER - Nice to have |
| Case-insensitive matching | LOW | Handles casing mismatches | IMPLEMENT with warning |

### Rejected Suggestions (With Reasoning)

| Suggestion | Why Rejected |
|------------|--------------|
| Normalize phases into separate table | Too large a schema change for this bug fix. Would require migration, dashboard updates, and extensive testing. Worth considering for v2. |
| Phase slugs as primary identifier | Requires schema change to save-development-plan. Better to handle in future holistic redesign. |
| Full audit history table | Over-engineering for current use case. Orchestration logs already provide some audit trail. |

### Implementation Plan (Prioritized)

**Phase 1: Critical Fixes (Blocking)**
1. Add status validation (pending, in_progress, completed, blocked)
2. Add progress_percent validation (0-100)
3. Add optimistic locking (WHERE updated_at = original)
4. Fix output to return JSON instead of human text

**Phase 2: Important Fixes (High Priority)**
5. Use UTC timestamps (datetime.now(timezone.utc))
6. Handle status transitions (clear completed_at on reversion)
7. Add started_at timestamp on first in_progress
8. Implement idempotency (no-op if unchanged)
9. Fail on ambiguous phase matches (multiple candidates)

**Phase 3: Enhancements (Nice to Have)**
10. Case-insensitive matching with warning
11. Add basic test coverage
12. Update documentation (command_examples.md, schema.md)

---

## Revised Assessment

**Before Review:** Implementation is FUNCTIONAL but INCOMPLETE (validation missing)
**After Review:** Implementation is FRAGILE - concurrent use will cause data corruption

The concurrency issue is the most critical finding. In a multi-agent orchestration system where multiple developers might update different phases simultaneously, the current read-modify-write pattern will cause lost updates. This is not an edge case - it's a core usage pattern.
