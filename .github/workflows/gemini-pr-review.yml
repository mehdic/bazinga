# Automated PR review workflow using Gemini API
name: Gemini PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > diff.patch

      - name: Build prompt
        env:
          BRANCH_URL: https://github.com/${{ github.repository }}/tree/${{ github.head_ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          cat > prompt_header.txt << 'EOF'
          You are reviewing a pull request.

          EOF

          echo "Pull Request Title: $PR_TITLE" >> prompt_header.txt
          echo "" >> prompt_header.txt
          echo "Branch URL: $BRANCH_URL" >> prompt_header.txt
          echo "" >> prompt_header.txt

          cat >> prompt_header.txt << 'EOF'
          Please use the branch URL above to access and understand the full project context, including:
          - The overall project structure and architecture
          - Existing code patterns and conventions
          - Related files and dependencies
          - The broader context of these changes

          Below is the Git diff of the changes in this PR:

          EOF

          # Truncate diff if too large
          if [ $(wc -c < diff.patch) -gt 40000 ]; then
            echo "Note: The diff has been truncated due to size limits." >> prompt_header.txt
            echo "" >> prompt_header.txt
            head -c 40000 diff.patch > diff_truncated.patch
            cat diff_truncated.patch >> prompt_header.txt
          else
            cat diff.patch >> prompt_header.txt
          fi

          cat >> prompt_header.txt << 'EOF'

          Using the project context from the branch, please analyze this diff and provide:
          1. Potential bugs or regressions - Consider how these changes interact with the existing codebase
          2. Style or readability issues - Compare against the project's existing code patterns
          3. Concrete suggestions for improvement - Based on the project's architecture and conventions

          Format your response as a concise, markdown-formatted code review suitable for posting as a PR comment.
          EOF

      - name: Call Gemini API
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PROMPT=$(cat prompt_header.txt | jq -Rs .)

          PAYLOAD=$(cat <<EOF
          {
            "contents": [{
              "parts": [{"text": $PROMPT}]
            }]
          }
          EOF
          )

          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: $GEMINI_API_KEY" \
            -d "$PAYLOAD" \
            https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent \
            | jq -r '.candidates[0].content.parts[0].text' > review.txt

      - name: Post review comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_BODY=$(jq -Rs . < review.txt)
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -d "{\"body\": $REVIEW_BODY}"
