# Automated PR review workflow using Gemini API
name: Gemini PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      - name: Compute diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > diff.patch

      - name: Find previous review analysis
        id: previous_review
        run: |
          # Find the most recent PR review analysis from this branch
          # This ensures continuity by providing context from previous reviews
          LATEST_REVIEW=""

          # Look for research/pr*-review-analysis.md files, get most recent
          if ls research/pr*-review-analysis.md 1> /dev/null 2>&1; then
            LATEST_REVIEW=$(ls -t research/pr*-review-analysis.md 2>/dev/null | head -1)
          fi

          if [ -n "$LATEST_REVIEW" ] && [ -f "$LATEST_REVIEW" ]; then
            echo "Found previous review: $LATEST_REVIEW"
            echo "has_previous=true" >> $GITHUB_OUTPUT
            echo "file=$LATEST_REVIEW" >> $GITHUB_OUTPUT
          else
            echo "No previous review analysis found"
            echo "has_previous=false" >> $GITHUB_OUTPUT
          fi

      - name: Build prompt
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: ${{ github.head_ref }}
          HAS_PREVIOUS: ${{ steps.previous_review.outputs.has_previous }}
          PREVIOUS_FILE: ${{ steps.previous_review.outputs.file }}
        run: |
          # Configuration
          # Max diff size in characters - Gemini API has token limits
          # 40k chars ≈ 10k tokens, leaving headroom for prompt + response
          MAX_DIFF_SIZE=40000
          MAX_PREVIOUS_SIZE=8000

          cat > prompt_header.txt << 'EOF'
          You are an expert code reviewer analyzing a pull request.

          EOF

          # Sanitize and add PR metadata
          echo "Pull Request Title: $PR_TITLE" >> prompt_header.txt
          echo "Repository: $REPO_NAME" >> prompt_header.txt
          echo "Branch: $BRANCH_NAME" >> prompt_header.txt
          echo "" >> prompt_header.txt

          # Include previous review context if available (for continuity)
          if [ "$HAS_PREVIOUS" = "true" ] && [ -f "$PREVIOUS_FILE" ]; then
            echo "## Previous Review Context" >> prompt_header.txt
            echo "" >> prompt_header.txt
            echo "A previous review analysis exists for this branch. Use it to:" >> prompt_header.txt
            echo "- Avoid repeating issues that were already addressed" >> prompt_header.txt
            echo "- Check if your feedback was already validated/rejected" >> prompt_header.txt
            echo "- Ensure continuity in the review process" >> prompt_header.txt
            echo "" >> prompt_header.txt
            echo "Previous analysis (truncated if large):" >> prompt_header.txt
            echo '```markdown' >> prompt_header.txt
            head -c "$MAX_PREVIOUS_SIZE" "$PREVIOUS_FILE" >> prompt_header.txt
            echo '' >> prompt_header.txt
            echo '```' >> prompt_header.txt
            echo "" >> prompt_header.txt
          fi

          cat >> prompt_header.txt << 'EOF'
          NOTE: You are provided with the complete Git diff below. Use this diff to understand all changes in this PR.

          Please analyze the diff and provide:
          1. Potential bugs or regressions - Consider how these changes interact with the existing codebase
          2. Style or readability issues - Code quality and maintainability concerns
          3. Concrete suggestions for improvement - Specific, actionable recommendations

          IMPORTANT: If previous review context was provided above, acknowledge what was already addressed and focus on NEW issues or remaining concerns.

          Format your response as a concise, markdown-formatted code review suitable for posting as a PR comment.

          Below is the Git diff of the changes:

          ```diff
          EOF

          # Truncate diff if too large (with safe command substitution)
          DIFF_SIZE="$(wc -c < diff.patch 2>/dev/null || echo 0)"
          if [ "$DIFF_SIZE" -gt "$MAX_DIFF_SIZE" ]; then
            echo "" >> prompt_header.txt
            echo "⚠️ Note: The diff has been truncated to ${MAX_DIFF_SIZE} characters due to size limits." >> prompt_header.txt
            echo "" >> prompt_header.txt
            head -c "$MAX_DIFF_SIZE" diff.patch >> prompt_header.txt
          else
            cat diff.patch >> prompt_header.txt
          fi

          cat >> prompt_header.txt << 'EOF'
          ```
          EOF

      - name: Call Gemini API
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set +x  # Prevent API key from appearing in logs

          PROMPT=$(cat prompt_header.txt | jq -Rs . 2>/dev/null)
          if [ -z "$PROMPT" ]; then
            echo "⚠️ Failed to prepare prompt. Check prompt_header.txt formatting." > review.txt
            exit 0
          fi

          PAYLOAD=$(cat <<EOF
          {
            "contents": [{
              "parts": [{"text": $PROMPT}]
            }]
          }
          EOF
          )

          echo "Calling Gemini API..."

          # Save response to file with extended timeout for Gemini 3 Pro
          # --connect-timeout 30: Allow 30s to establish connection
          # --max-time 210: Allow 3.5 minutes for complete response (Gemini 3 Pro can be slow)
          HTTP_CODE=$(curl -s \
            --connect-timeout 30 \
            --max-time 210 \
            -w "%{http_code}" \
            -o gemini_response.json \
            -X POST \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: $GEMINI_API_KEY" \
            -d "$PAYLOAD" \
            https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent)

          CURL_EXIT=$?

          echo "HTTP Status: $HTTP_CODE"
          echo "Curl exit code: $CURL_EXIT"

          # Handle timeout errors (exit code 28)
          if [ "$CURL_EXIT" -eq 28 ]; then
            echo "Error: API request timed out after 210 seconds"
            echo "## ⚠️ Gemini API Timeout" > review.txt
            echo "" >> review.txt
            echo "The Gemini 3 Pro model took too long to respond (greater than 3.5 minutes). This can happen with large diffs or complex analysis." >> review.txt
            echo "" >> review.txt
            echo "**Suggestions:**" >> review.txt
            echo "- Try reducing the diff size" >> review.txt
            echo "- Use a faster model (e.g., gemini-2.5-flash)" >> review.txt
            echo "- Retry the workflow" >> review.txt
            exit 0
          fi

          # Handle other curl errors
          if [ "$CURL_EXIT" -ne 0 ]; then
            echo "Error: Curl failed with exit code $CURL_EXIT"
            echo "## ⚠️ Network Error" > review.txt
            echo "" >> review.txt
            echo "Failed to connect to Gemini API (curl exit code: $CURL_EXIT)." >> review.txt
            echo "" >> review.txt
            echo "**Please check:**" >> review.txt
            echo "- Network connectivity" >> review.txt
            echo "- API endpoint availability" >> review.txt
            echo "- Retry the workflow" >> review.txt
            exit 0
          fi

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: Gemini API returned status $HTTP_CODE"
            cat gemini_response.json

            # Build error message based on HTTP status
            if [ "$HTTP_CODE" == "429" ]; then
              echo "## ⚠️ Gemini API Error (HTTP $HTTP_CODE)" > review.txt
              echo "" >> review.txt
              echo "Rate limit exceeded. Please check your API quota at https://aistudio.google.com/app/apikey" >> review.txt
            elif [ "$HTTP_CODE" == "401" ] || [ "$HTTP_CODE" == "403" ]; then
              echo "## ⚠️ Gemini API Error (HTTP $HTTP_CODE)" > review.txt
              echo "" >> review.txt
              echo "Authentication failed. Please verify GEMINI_API_KEY secret is configured correctly." >> review.txt
            else
              echo "## ⚠️ Gemini API Error (HTTP $HTTP_CODE)" > review.txt
              echo "" >> review.txt
              echo "API call failed. Check workflow logs for details." >> review.txt
            fi

            exit 0
          fi

          # Parse response with error handling
          if ! jq -e '.candidates[0].content.parts[0].text' gemini_response.json > /dev/null 2>&1; then
            echo "⚠️ Gemini API returned an unexpected response format. Response:" > review.txt
            cat gemini_response.json >> review.txt
            exit 0
          fi

          jq -r '.candidates[0].content.parts[0].text' gemini_response.json > review.txt

          if [ ! -s review.txt ]; then
            echo "⚠️ Review file is empty. Gemini may have returned no content." > review.txt
            exit 0
          fi

          echo "Review generated successfully ($(wc -c < review.txt) bytes)"
          echo "Preview:"
          head -n 10 review.txt

      - name: Post review comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Preparing to post review comment..."

          if [ ! -f review.txt ]; then
            echo "Error: review.txt not found"
            exit 1
          fi

          REVIEW_SIZE="$(wc -c < review.txt)"
          echo "Review content length: $REVIEW_SIZE bytes"

          REVIEW_BODY=$(jq -Rs . < review.txt 2>/dev/null)
          if [ -z "$REVIEW_BODY" ]; then
            echo "Error: Failed to encode review content as JSON"
            exit 1
          fi

          echo "Posting comment to PR #${{ github.event.pull_request.number }}..."

          HTTP_CODE=$(curl -s -w "%{http_code}" -o comment_response.json \
            --connect-timeout 10 \
            --max-time 30 \
            -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -d "{\"body\": $REVIEW_BODY}")

          if [ "$HTTP_CODE" != "201" ]; then
            echo "Error: Failed to post comment (HTTP $HTTP_CODE)"
            cat comment_response.json
            exit 1
          fi

          echo "✅ Comment posted successfully!"
          jq '.html_url' comment_response.json
