name: Gemini PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute diff
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          git diff origin/${{ github.base_ref }}...HEAD > diff.patch

      - name: Generate review with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BRANCH_URL: https://github.com/${{ github.repository }}/tree/${{ github.head_ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          cat > review_script.py << 'PYTHON_SCRIPT'
          import json
          import os
          import sys
          import urllib.request

          # Read diff
          with open('diff.patch', 'r') as f:
              diff_content = f.read()

          # Get branch URL and PR title
          branch_url = os.environ.get("BRANCH_URL", "")
          pr_title = os.environ.get("PR_TITLE", "")

          # Truncate if too large
          max_chars = 40000
          truncated = False
          if len(diff_content) > max_chars:
              diff_content = diff_content[:max_chars]
              truncated = True

          # Build prompt
          truncation_note = "Note: The diff has been truncated due to size limits." if truncated else ""

          prompt = f"""You are reviewing a pull request.

          Pull Request Title: {pr_title}

          Branch URL: {branch_url}

          Please use the branch URL above to access and understand the full project context, including:
          - The overall project structure and architecture
          - Existing code patterns and conventions
          - Related files and dependencies
          - The broader context of these changes

          Below is the Git diff of the changes in this PR:

          {truncation_note}

          {diff_content}

          Using the project context from the branch, please analyze this diff and provide:
          1. Potential bugs or regressions - Consider how these changes interact with the existing codebase
          2. Style or readability issues - Compare against the project's existing code patterns
          3. Concrete suggestions for improvement - Based on the project's architecture and conventions

          Format your response as a concise, markdown-formatted code review suitable for posting as a PR comment.
          """

          # Prepare Gemini API request
          url = "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent"
          headers = {
              "Content-Type": "application/json",
              "x-goog-api-key": os.environ["GEMINI_API_KEY"]
          }

          payload = {
              "contents": [
                  {
                      "parts": [
                          {"text": prompt}
                      ]
                  }
              ]
          }

          # Call Gemini API
          req = urllib.request.Request(
              url,
              data=json.dumps(payload).encode('utf-8'),
              headers=headers
          )

          try:
              with urllib.request.urlopen(req) as response:
                  result = json.loads(response.read().decode('utf-8'))

              # Extract review text
              review_text = result['candidates'][0]['content']['parts'][0]['text']

              # Write review to file for next step
              with open('review.txt', 'w') as f:
                  f.write(review_text)

              print("Review generated successfully")

          except Exception as e:
              print(f"Error calling Gemini API: {e}", file=sys.stderr)
              sys.exit(1)
          PYTHON_SCRIPT

          python3 review_script.py

      - name: Post review comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_BODY=$(jq -Rs . < review.txt)
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -d "{\"body\": $REVIEW_BODY}"
